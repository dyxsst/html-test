name: Scrape Images

on:
  workflow_dispatch:
    inputs:
      slug:
        description: 'Manga slug (e.g., i-can-copy-talents)'
        required: true
      chapter:
        description: 'Chapter folder (e.g., chapter-1)'
        required: true
      start_page:
        description: 'Start page (number)'
        required: false
        default: '1'
      end_page:
        description: 'End page (number)'
        required: false
        default: '25'
      pad_width:
        description: 'Zero pad width (1/2/3)'
        required: false
        default: '3'
      ext:
        description: 'Image extension (jpg/png)'
        required: false
        default: 'jpg'
      base_host:
        description: 'Base host for images'
        required: false
        default: 'https://img.manhuaus.com'
      commit_images:
        description: 'If true, commit downloaded images back to the repo (use with caution)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run scraper
      env:
        SLUG: ${{ github.event.inputs.slug }}
        CHAPTER: ${{ github.event.inputs.chapter }}
        START_PAGE: ${{ github.event.inputs.start_page }}
        END_PAGE: ${{ github.event.inputs.end_page }}
        PAD_WIDTH: ${{ github.event.inputs.pad_width }}
        EXT: ${{ github.event.inputs.ext }}
        BASE_HOST: ${{ github.event.inputs.base_host }}
        OUT_DIR: images
      run: |
        python scraper.py --slug "$SLUG" --chapter "$CHAPTER" --start $START_PAGE --end $END_PAGE --pad $PAD_WIDTH --ext $EXT --base "$BASE_HOST" --out "$OUT_DIR"

    - name: Upload images artifact
      uses: actions/upload-artifact@v4
      with:
        name: scraped-images
        path: images/

    - name: Commit images back to repo (optional)
      if: ${{ github.event.inputs.commit_images == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add images || true
        if git diff --staged --quiet; then
          echo "No new images to commit"
          exit 0
        fi
        git commit -m "Add images for ${{ github.event.inputs.slug }}/${{ github.event.inputs.chapter }} [ci skip]"
        git push origin HEAD:main