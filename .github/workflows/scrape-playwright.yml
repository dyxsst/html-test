name: Scrape Images (Playwright)

on:
  workflow_dispatch:
    inputs:
      slug:
        description: 'Manga slug (e.g., i-can-copy-talents)'
        required: true
      chapter:
        description: 'Chapter folder (e.g., chapter-1)'
        required: true
      base_host:
        description: 'Image server host'
        required: false
        default: 'https://img.manhuaus.com'
      page_base:
        description: 'Manga page base URL'
        required: false
        default: 'https://manhuaus.com/manga'
      commit_images:
        description: 'If true, commit downloaded images back to the repo'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright browsers
      run: |
        python -m playwright install --with-deps

    - name: Run Playwright scraper
      env:
        SLUG: ${{ github.event.inputs.slug }}
        CHAPTER: ${{ github.event.inputs.chapter }}
        BASE_HOST: ${{ github.event.inputs.base_host }}
        PAGE_BASE: ${{ github.event.inputs.page_base }}
        OUT_DIR: images
      run: |
        python scrape_playwright.py --slug "$SLUG" --chapter "$CHAPTER" --base-host "$BASE_HOST" --page-base "$PAGE_BASE" --out "$OUT_DIR"

    - name: Upload images artifact
      uses: actions/upload-artifact@v4
      with:
        name: scraped-images-playwright
        path: images/

    - name: Commit images back to repo (optional)
      if: ${{ github.event.inputs.commit_images == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add images || true
        if git diff --staged --quiet; then
          echo "No new images to commit"
          exit 0
        fi
        git commit -m "Add images for ${{ github.event.inputs.slug }}/${{ github.event.inputs.chapter }} [ci skip]"
        git push origin HEAD:main
